# quark
OpenXR rust runtime/api layer implementation library

## Creating an OpenXR API Layer with Quark

### 1. Set up the project

Create a new Cargo project:

```bash
cargo new my_api_layer --lib
cd my_api_layer
```

Update `Cargo.toml`:

```toml
[package]
name = "my_api_layer"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[dependencies]
quark = { git = "https://github.com/Sorenon/quark.git" }
```

### 2. Create the OpenXR JSON manifest

Create a file named `XR_APILAYER_NOVENDOR_my_layer.json`:

```json
{
    "file_format_version": "1.0.0",
    "api_layer": {
        "name": "XR_APILAYER_NOVENDOR_my_layer",
        "library_path": "./target/debug/libmy_api_layer.so",
        "api_version": "1.0",
        "implementation_version": "1",
        "description": "My Quark API Layer"
    }
}
```

### 3. Set up a justfile for easy testing

Create a `justfile`:

```make
build:
    cargo build

test:
    XR_ENABLE_API_LAYERS=XR_APILAYER_NOVENDOR_my_layer XR_API_LAYER_PATH=$PWD hello_xr -G Vulkan

build-and-test:
    just build && just test
```

### 4. Implement the API Layer

In `src/lib.rs`:

```rust
use quark::{
    openxr::{self, sys::InstanceCreateInfo, Entry, Instance},
    prelude::*,
    APILayerInstanceData,
};

// Define your instance data
#[quark::handle(openxr::sys::Instance)]
pub struct InstanceData {
    instance: openxr::Instance,
}

impl APILayerInstanceData for InstanceData {
    fn create(
        entry: Entry,
        instance_info: &InstanceCreateInfo,
        instance: openxr::sys::Instance,
    ) -> XrResult<Self> {
        let app_name = instance_info
            .application_info
            .application_name
            .to_rust_string()?;
        println!("Created instance for application: {app_name}");
        let instance = unsafe {
            openxr::Instance::from_raw(entry, instance, openxr::InstanceExtensions::default())
        }?;
        Ok(InstanceData { instance })
    }

    fn entry(&self) -> &Entry {
        self.instance.entry()
    }
}

// Define the API layer
quark::api_layer! {
    instance_data: InstanceData,
    override_fns: {
        // Add functions to override here
        // xrSomeFunction: my_override_function,
    }
}

// Implement override functions as needed
// #[quark::wrap_openxr]
// fn my_override_function(...) -> XrResult { ... }
```

### 5. Override OpenXR functions

1. Consult the [OpenXR Specification](https://registry.khronos.org/OpenXR/specs/1.0/html/xrspec.html) to identify functions you want to override.
2. Add them to the `override_fns` section in the `api_layer!` macro.
3. Implement the override functions using the `#[quark::wrap_openxr]` attribute.

Example:

```rust
quark::api_layer! {
    instance_data: InstanceData,
    override_fns: {
        xrCreateSession: create_session,
    }
}

#[quark::wrap_openxr]
fn create_session(
    instance: openxr::sys::Instance,
    create_info: &openxr::sys::SessionCreateInfo,
    session: &mut openxr::sys::Session,
) -> XrResult {
    println!("Creating a new session!");
    let instance_data = instance.data()?;
    cvt(|| unsafe { (instance_data.instance.fp().create_session)(instance, create_info, session) })
}
```

### 6. Handle custom data for other OpenXR handles

For handles other than `Instance`, create custom data structures:

```rust
#[quark::handle(openxr::sys::Session)]
pub struct SessionData {
    // Add relevant data fields
}

// Implement creation and destruction
#[quark::wrap_openxr]
fn create_session(
    instance: openxr::sys::Instance,
    create_info: &openxr::sys::SessionCreateInfo,
    session: &mut openxr::sys::Session,
) -> XrResult {
    // ... implementation ...
    session.add_data(SessionData { /* ... */ });
    Ok(())
}

// The destroy function is automatically generated by the #[quark::handle] macro
```

### 7. Build and test

Run the following command to build and test your API layer:

```bash
just build-and-test
```

### 9. Reference the `api_layer_test` project

For more detailed examples and important implementation quirks, refer to the `api_layer_test` project in the Quark repository. This project contains extensive comments explaining various nuances and best practices when working with Quark for API layers.

Key areas to pay attention to in `api_layer_test`:
- Handling of OpenXR string types
- Proper use of the `.data()` method on handles
- Interaction between Quark and OpenXRS
- Correct handling of OpenXR handles and their associated data

Reviewing this project will provide valuable insights into advanced usage and help you avoid common pitfalls when developing your own API layers.
